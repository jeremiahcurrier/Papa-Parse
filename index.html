<!DOCTYPE HTML>
<!--
Source: https://cmatskas.com/importing-csv-files-using-jquery-and-html5/
-->
<html lang = "en">
<head>
  <title>File Upload Test</title>
  <meta charset = "UTF-8" />
  
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <!-- jQuery library -->
  <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>-->
  <!-- Latest compiled JavaScript -->
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js" type="text/javascript"></script>
  
  <script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/latest/zaf_sdk.js"></script>

  <script type="text/javascript">

    $(document).ready(function() {



      // console.log('document:');
      // console.log(document);
      // console.log('window:');
      // console.log(window);



      var app = window.ZAFClient.init();



      // console.log('app:');
      // console.log(app);



    // app.postMessage('hello', { foo: true }); // post the message 'hello' to the Zendesk app

    // listen to the 'app.registered' event, which is fired by the framework once the iframe is registered with the app
    // app.on('app.registered', function(data) {
    //   // go nuts
    // });

    // app.on('helloIframe', function(data) { // listen to the 'helloIframe' message sent from the app
    //   if (data.bar) {
    //     // app says hello
    //   }
    // });
        
        // The event listener for the file upload
        document.getElementById('txtFileUpload').addEventListener('change', upload, false);
    
        // Method that checks that the browser supports the HTML5 File API
        function browserSupportFileUpload() {
            var isCompatible = false;
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                isCompatible = true;
            }

            return isCompatible;
        };

        function upload(evt) {
            if (!browserSupportFileUpload()) {
                alert('The File APIs are not fully supported in this browser!');
            } else {
                var data = null;
                var file = evt.target.files[0];
                var reader = new FileReader();
                reader.readAsText(file);
                reader.onload = function(event) {
                        var csvData = event.target.result;
                        data = $.csv.toArrays(csvData);
                        if (data && data.length > 0) {
                          console.log('data:');
                          console.log(data);
                          console.log('app:');
                          console.log(app);

                          app.postMessage('hello', { foo: true }); // post the message 'hello' to the Zendesk app

                          app.postMessage('hello'); // post the message 'hello' to the Zendesk app

                          console.log('before');

                          // listen to the 'app.registered' event, which is fired by the framework once the iframe is registered with the app
                          app.on('app.registered', function(data) {
                            // go nuts
                            console.log('app registered');
                          });

                          console.log('after');

                          alert('Imported -' + data.length + '- rows successfully!');
                        } else {
                          alert('No data to import!');
                        }
                    };
                    reader.onerror = function() {
                         alert('Unable to read ' + file.fileName);
                    };
            };
        };
    });
  </script>
  
</head>
<body>
  <div class="well container">
    <h1>File Upload Test</h1>
    <p>
      <div id="dvImportSegments" class="fileupload ">
        <fieldset>
          <legend>Select the CSV file to upload</legend>
            <input type="file" name="File Upload" id="txtFileUpload" accept=".csv" />
        </fieldset>
      </div>
    </p>
  </div>
  
</body>
</html>
